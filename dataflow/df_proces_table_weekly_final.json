{
	"name": "df_proces_table_weekly_final",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "raw_statistiek_ingest",
						"type": "DatasetReference"
					},
					"name": "source1"
				},
				{
					"dataset": {
						"referenceName": "ref_mapping_aplaza_id",
						"type": "DatasetReference"
					},
					"name": "source2"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "stg_events_current",
						"type": "DatasetReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [
				{
					"name": "derivedColumn1"
				},
				{
					"name": "join1"
				},
				{
					"name": "derivedColumn2"
				},
				{
					"name": "select1"
				}
			],
			"scriptLines": [
				"source(output(",
				"          EventId as string,",
				"          MachineName as string,",
				"          Title as string,",
				"          TimeStamp as string,",
				"          Message as string,",
				"          UserIdentity as string,",
				"          GimFunction as string,",
				"          Week as string,",
				"          Year as string,",
				"          MyAand as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> source1",
				"source(output(",
				"          role_group as string,",
				"          role_group_aplaza_id as string,",
				"          username as string,",
				"          aplaza_id as string,",
				"          id as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> source2",
				"source1 derive(gim_function_number = split(GimFunction, '.')[1],",
				"          my_aand_user = iif(\r",
				"    MyAand == 'N741' || MyAand == 'H742',\r",
				"    concat(MyAand, '_', UserIdentity),\r",
				"    ''\r",
				"),",
				"          functie_id = concat(\r",
				"    split(GimFunction, '.')[ size(split(GimFunction, '.')) - 1 ],\r",
				"    '.',\r",
				"    split(GimFunction, '.')[ size(split(GimFunction, '.')) ]\r",
				")) ~> derivedColumn1",
				"derivedColumn1, source2 join(lower(trim(UserIdentity)) == lower(trim(username)),",
				"     joinType:'cross',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> join1",
				"join1 derive(aplaza_id = iif(     !isNull(aplaza_id) && aplaza_id != '',     aplaza_id,     role_group_aplaza_id )) ~> derivedColumn2",
				"derivedColumn2 select(mapColumn(",
				"          event_id = EventId,",
				"          message = Message,",
				"          user_identity = UserIdentity,",
				"          gim_function = GimFunction,",
				"          gim_function_number,",
				"          week = Week,",
				"          jaar = Year,",
				"          my_aand = MyAand,",
				"          confirmation_at = TimeStamp,",
				"          aplaza_id,",
				"          functie_id,",
				"          my_aand_user",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select1",
				"select1 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          event_id as string,",
				"          user_identity as string,",
				"          message as string,",
				"          gim_function as string,",
				"          gim_function_number as string,",
				"          week as string,",
				"          jaar as string,",
				"          my_aand as string,",
				"          confirmation_at as string,",
				"          aplaza_id as string,",
				"          functie_id as string,",
				"          my_aand_user as string",
				"     ),",
				"     umask: 0022,",
				"     preCommands: [],",
				"     postCommands: [],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     saveOrder: 1,",
				"     partitionBy('hash', 1)) ~> sink1"
			]
		}
	}
}